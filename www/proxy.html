<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title>Proxy</title>
</head>

<body>
    <div id="app">
        <div class="container">
            <div class="top__block">
                <h1 class="app_title" >Proxy</h1>
                <ul class="menu">
                    <li>
                        <a @click="loadProxyFromFile">Add</a>
                    </li>
                    <li>
                        <a @click="freeProxy">Free</a>
                    </li>
                    <li>
                        <a @click="getAllProxy">All</a>
                    </li>
                    <li>
                        <a @click="clearAllProxy">Clear</a>
                    </li>
                </ul>
            </div>
            <!-- <div class="left__block">

            </div> -->
            <div class="right__block">
                <div class="cards">
                    <div @click="() => { pointer = 0; setItems('all') }" class="card">
                        <div class="card_title">
                            <span>Всего прокси</span>
                        </div>
                        <div class="card_value">
                            <span> {{ proxies.length }} </span>
                        </div>
                    </div>

                    <div @click="() => { pointer = 0; setItems('busy') }" class="card">
                        <div class="card_title">
                            <span>Use прокси</span>
                        </div>
                        <div class="card_value">
                            <span> {{ proxies.filter( i => i.IsBusy === true).length }} </span>
                        </div>
                    </div>

                    <div @click="() => { pointer = 0; setItems('bad') }" class="card">
                        <div class="card_title">
                            <span>Bad прокси</span>
                        </div>
                        <div class="card_value">
                            <span> {{ proxies.filter( i => i.IsBad === true).length }} </span>
                        </div>
                    </div>
                </div>

                <div class="lists">
                    <ul class="list">
                        <li v-for="p in items" :key="p.ID">
                            <span class="">{{ p.ID }} </span>
                            <span class="">{{ p.Login }} </span>
                            <span class="">{{ p.DateAdd }} </span>
                            <span class="">{{ p.DateLastUse ? p.DateLastUse : "---" }} </span>
                            <span class="">{{ p.IsBad }} </span>
                            <span class="">{{ p.IsBusy }} </span>
                            <span @click="removeProxy(p.ID)">Remove</span>
                        </li>
                    </ul>

                    <ul class="pagination">
                        <li>
                            <a @click="updatePoiner(-1)"><</a>
                        </li>
                        <li>
                            <a @click="updatePoiner(1)">></a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>


    <script src="js/vue.js"></script>
    <script>
        var app = new Vue({
            el: "#app",
            data: {
                proxies: [],
                items: [],
                pointer: 0,
                typeSortArray: 'all'
            },
            methods: {
                updatePoiner: function(step){
                    this.pointer = this.pointer + step
                    this.setItems(this.typeSortArray)
                }, 
                setItems: function(type){
  
                    if(type === "all" ){
                        this.items = this.proxies.slice(this.pointer * 10, (this.pointer * 10) + 9)
                        this.typeSortArray = 'all'
                    }
                    
                    if(type === "busy" ){
                        this.items = this.proxies.filter( p => p.IsBusy === true).slice(this.pointer, this.pointer + 10)
                        this.typeSortArray = 'busy'
                    }
                    
                    if(type === "bad" ){
                        this.items = this.proxies.filter( p => p.IsBad === true).slice(this.pointer, this.pointer + 10)
                        this.typeSortArray = 'bad'
                    }
                },
                freeProxy: async function () {
                    var result = await this.getFetchData("proxy/free", "GET")
                    if (result.code === 403) {
                        document.location.href = "/login"
                        return
                    }

                    console.log(result)
                },
                removeProxy: async function(id){
                    await this.getFetchData("proxy/clear/" + id, "GET")
                    if (result.code === 403) {
                        document.location.href = "/login"
                        return
                    }

                    if (result.code === 200) {
                        this.getAllProxy()
                    }
                },
                clearAllProxy: async function () {

                    await this.getFetchData("proxy/clear", "GET")
                    if (result.code === 403) {
                        document.location.href = "/login"
                        return
                    }

                    if (result.code === 200) {
                        this.getAllProxy()
                    }
                },
                getAllProxy: async function () {
                    var result = await this.getFetchData("proxy/all", "GET")

                    if (result.code === 403) {
                        document.location.href = "/login"
                        return
                    }

                    if (result.code === 200) {
                        this.proxies = result.data.proxies
                        this.setItems(this.typeSortArray)
                    }
                },
                addProxy: async function (e) {
                    var lines = e.target.result.split("\n")
                    var result = await this.getFetchData("/proxy/add", "POST", { urls: lines })
                    if (result.code === 200) {
                        this.getAllProxy()
                    }
                },
                loadProxyFromFile: async function () {
                    var input = document.createElement('input');
                    input.type = "file";
                    input.onchange = ev => {
                        const file = ev.target.files[0];
                        const reader = new FileReader();

                        reader.onload = e => this.addProxy(e)
                        reader.readAsText(file);
                    }
                    input.click()
                },
                getFetchData: async function (url, method, data) {
                    var response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    })

                    return response.json()
                },
            },

            created: function () {
                this.getAllProxy()
            }
        })
    </script>
</body>

</html>